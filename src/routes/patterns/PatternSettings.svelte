<script lang="ts">
  import {
    Card,
    CardContent,
    CardDescription,
    CardFooter,
    CardHeader,
    CardTitle,
  } from "$lib/components/ui/card";
  import { Button } from "$lib/components/ui/button";
  import { Input } from "$lib/components/ui/input";
  import { invoke } from "@tauri-apps/api/core";
  import { onMount } from "svelte";

  let gitRepo = "";
  let gitFolder = "";

  async function loadGitSettings() {
    try {
      gitRepo = await invoke("get_patterns_git_repo");
      gitFolder = await invoke("get_patterns_git_folder");
    } catch (err) {
      console.error("Failed to load git settings:", err);
    }
  }

  async function saveGitSettings() {
    try {
      await invoke("set_patterns_git_repo", { repoUrl: gitRepo });
      await invoke("set_patterns_git_folder", { folderPath: gitFolder });
    } catch (err) {
      console.error("Failed to save git settings:", err);
    }
  }

  let isUpdating = false;

  async function handleUpdatePatterns() {
    if (isUpdating) return;

    isUpdating = true;
    try {
      console.log("Updating patterns...");
      const result = await invoke("update_patterns");
      console.log("Patterns updated:", result);
    } catch (error) {
      console.error("Failed to update patterns:", error);
    } finally {
      isUpdating = false;
    }
  }

  onMount(async () => {
    await loadGitSettings();
  });
</script>

<Card class="mb-6">
  <CardHeader class="flex flex-row items-center justify-between">
    <div>
      <CardTitle>Git Pattern Settings</CardTitle>
      <CardDescription
        >Configure pattern loading from git repository</CardDescription
      >
    </div>
    <Button
      variant="outline"
      on:click={handleUpdatePatterns}
      disabled={isUpdating}
    >
      {isUpdating ? "Updating..." : "Update Patterns"}
    </Button>
  </CardHeader>
  <CardContent class="space-y-4">
    <div class="space-y-2">
      <label for="gitRepo">Git Repository URL</label>
      <Input
        id="gitRepo"
        bind:value={gitRepo}
        placeholder="https://github.com/user/repo"
      />
    </div>
    <div class="space-y-2">
      <label for="gitFolder">Patterns Folder Path</label>
      <Input id="gitFolder" bind:value={gitFolder} placeholder="patterns/" />
    </div>
  </CardContent>
  <CardFooter class="flex gap-2">
    <Button on:click={saveGitSettings}>Save Settings</Button>
  </CardFooter>
</Card>
